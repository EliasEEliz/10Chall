"use strict";
var json_1 = require('streaming/json');
var property_1 = require('streaming/property');
var parser_1 = require('./parser');
exports.Parser = parser_1.Parser;
var stringifier_1 = require('./stringifier');
exports.Stringifier = stringifier_1.Stringifier;
function transform(input, parserConfig, stringifierConfig, callback) {
    var transforms = [
        parserConfig.json ? new json_1.Parser() : new parser_1.Parser(parserConfig),
    ];
    if (stringifierConfig.omit) {
        transforms.push(new property_1.Omitter(stringifierConfig.omit.split(/,/g)));
    }
    if (stringifierConfig.filter) {
        transforms.push(new property_1.Picker(stringifierConfig.filter.split(/,/g)));
    }
    var stringifier = stringifierConfig.json ? new json_1.Stringifier() : new stringifier_1.Stringifier(stringifierConfig);
    transforms.push(stringifier);
    var output = transforms.reduce(function (outputStream, transform) { return outputStream.pipe(transform); }, input).pipe(process.stdout);
    output.on('finish', callback);
    output.on('error', function (error) {
        // panic! (lets us quit faster, actually)
        input.unpipe();
        // output.unpipe();
        callback(error);
    });
}
exports.transform = transform;
